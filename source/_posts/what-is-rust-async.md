---
title: æ–‡çµ„ä¹Ÿèƒ½æ‡‚çš„ Rust async æ©Ÿåˆ¶
date: 2022-08-07 13:03:20
updated: 2022-08-07 19:59:00
tags:
    - Rust
    - async
    - easy
    - simple
categories: Development
---

## èƒŒæ™¯

<https://twitter.com/repsiace/status/1554103778994900992/>

![Rust async åˆ°åº•æ˜¯ä»€éº¼å•Šå•Šå•Šå•Š](20220807130414.webp)

> ä¿®æ”¹ä¸€ä¸‹ï¼šwork stealing, thread-per-core, waker, mpsc, task queue åªæœ‰ä»–ä»¬æ‡‚... æ­£å¸¸äººä¸å¯èƒ½çœ‹æ‡‚ â€“ [@twicemoemoe, 22-08-02](https://twitter.com/twicemoemoe/status/1554305217134735362)

ä½œç‚ºä¸€å€‹æ–‡çµ„ï¼Œå…¶å¯¦è¦ºå¾— async çœŸçš„æ²’æœ‰æƒ³åƒä¸­çš„é€™éº¼å›°é›£â‹¯â‹¯ ğŸ˜‚ æˆ–è¨±æ­é…ä¸€äº›åœ–ç‰‡æœƒå¥½æ‡‚å¾ˆå¤šå§ã€‚

## TL;DR ä¸å»¢è©±ç‰ˆæœ¬

- **Sync**ï¼ˆåŒæ­¥ï¼‰ï¼šä¸€ä»¶äº‹æƒ…åšå®Œä¹‹å¾Œï¼Œå†åšä¸‹ä¸€ä»¶äº‹æƒ…ã€‚
  - **blocking**ï¼ˆå µå¡ï¼‰ï¼šæŒ‡ã€Œç­‰ä¸€ä»¶äº‹æƒ…ã€çš„è¡Œç‚ºã€‚
- **Async**ï¼ˆéåŒæ­¥ï¼‰ï¼šä¸€ä»¶äº‹æƒ…é‚„æ²’å®Œæˆï¼Œå¯ä»¥åšå…¶ä»–ä¸è¡çªçš„äº‹æƒ…ã€‚
  - **concurrency**ï¼ˆä¸¦è¡Œã€ä½µç™¼ï¼‰ï¼šç¨‹å¼ **æ¶æ§‹** ä¸­ï¼Œå„å€‹ä»»å‹™å¯ä»¥ **ç¨ç«‹åŸ·è¡Œ** çš„ç‰¹æ€§ã€‚
    - **future**ï¼šRust ä¸­çš„ä¸€å€‹éåŒæ­¥ä»»å‹™çš„è¡¨ç¤ºã€‚
    - **polling**ï¼šä¸åœåœ°è©¢å•ä»»å‹™ï¼Œç¢ºèªäº‹æƒ…æ˜¯å¦å·²ç¶“å®Œæˆã€‚
    - **event-driven**ï¼šäº‹æƒ…å®Œæˆå¾Œï¼Œä»»å‹™è‡ªå·±ç™¼é€šçŸ¥è¡¨æ˜å®Œæˆã€‚
  - **parallelism**ï¼ˆå¹³è¡Œï¼‰ï¼šåŒæ™‚ **åŸ·è¡Œ** æ•¸å€‹ç¨‹å¼çš„è¡Œç‚ºã€‚
    - **thread**ï¼ˆåŸ·è¡Œç·’ã€ç·šç¨‹ï¼‰ï¼šç³»çµ±è™•ç†ç¨‹å¼ï¼ˆä»»å‹™é›†ï¼‰çš„åŸºæœ¬å–®å…ƒã€‚thread é€šå¸¸æ˜¯äº¤ç”± CPU æ ¸å¿ƒåŸ·è¡Œã€‚
      - **spawn**ï¼ˆç”Ÿæˆï¼‰ï¼šæŒ‡ç”¢ç”Ÿ thread çš„è¡Œç‚ºã€‚
      - **thread pool**ï¼ˆåŸ·è¡Œç·’æ± ï¼‰ï¼šå°‡ thread é«˜æ•ˆåˆ†é…çµ¦æ¯å€‹ä»»å‹™çš„åœ°æ–¹ã€‚
- **Async runtime**: ä»¥ tokio ç‚ºä¾‹
  - **join** (macro)ï¼šä¸¦è¡ŒåŸ·è¡Œ async å‡½æ•¸ã€‚
  - **select** (macro)ï¼šå“ªå€‹ async å‡½æ•¸å¿«ï¼Œå›å‚³é‚£å€‹ async å‡½æ•¸çš„çµæœã€‚
  - **main** (attribute macro)ï¼šåœ¨ main() åˆå§‹åŒ– runtimeã€‚
  - **block_on**ï¼šåœ¨ sync ä¸ŠåŸ·è¡Œ async å‡½æ•¸ã€‚
  - **spawn**ï¼šå¹³è¡ŒåŸ·è¡Œ async å‡½æ•¸ã€‚
  - **spawn_blocking**ï¼šå› ç‚ºä¸€å€‹ä»»å‹™æœ¬èº«æœƒå µä½ (blocking) æ•´å€‹ç¨‹å¼ï¼Œå°±æ”¹ä¸Ÿåˆ°å¦ä¸€å€‹ç¨‹å¼ç¨ç«‹åŸ·è¡Œçš„è¡Œç‚ºã€‚

## åŒæ­¥ (Synchronous) è·ŸéåŒæ­¥ (Asynchoronous)

ã€Œ**åŒæ­¥**ã€å°±æ˜¯æ•´å€‹ç¨‹å¼ç­‰ä¸€ä»¶äº‹æƒ…å®Œæˆï¼ˆ**blocking**ï¼Œå µå¡ï¼‰ã€‚ã€Œ**éåŒæ­¥**ã€å‰‡æ˜¯ä¸€ä»¶äº‹æƒ…é‚„æ²’å®Œæˆï¼Œå¯ä»¥åšå…¶ä»–ä¸è¡çªçš„äº‹æƒ…ã€‚

å°±ä»¥æ—©é¤ä¾†èªªï¼Œã€ŒåŒæ­¥ã€å°±åƒæ˜¯ç­‰åå¸çƒ¤å®Œä¹‹å¾Œï¼Œæ‰å»æº–å‚™èŠ±ç”Ÿé†¬ï¼ˆ**æ¯ä»¶ä»»å‹™å¾ªåºæ¼¸é€²åœ°åŸ·è¡Œ**ï¼‰ï¼›ã€ŒéåŒæ­¥ã€å°±åƒæ˜¯åå¸æ­£åœ¨çƒ¤çš„æ™‚å€™ï¼Œå°±å…ˆæº–å‚™èŠ±ç”Ÿé†¬ï¼ˆ**æ¯ä»¶ä»»å‹™ä¸¦è¡Œåœ°åŸ·è¡Œ**ï¼‰ã€‚

![åŒæ­¥å’ŒéåŒæ­¥çš„åœ–è§£ã€‚](async-sync.webp)

## ä¸¦è¡Œ (Concurrency) èˆ‡å¹³è¡Œ (Parallelism)

å‰›æ‰æœ‰æåˆ°ã€Œåå¸æ­£åœ¨çƒ¤çš„æ™‚å€™ï¼Œå°±å…ˆæº–å‚™èŠ±ç”Ÿé†¬ã€æ˜¯å€‹ **ä¸¦è¡Œ** è¡Œç‚ºã€‚

**ä¸¦è¡Œ** å°±æ˜¯æŒ‡ç¨‹å¼æ¶æ§‹ï¼Œä»»å‹™å¯ä»¥äº’ä¸ç›¸é—œåŸ·è¡Œçš„ç‰¹æ€§ã€‚æˆ‘å€‘å¯ä»¥ç¨±ã€Œåå¸æ­£åœ¨çƒ¤ã€å’Œã€Œæº–å‚™èŠ±ç”Ÿé†¬ã€æ˜¯å€‹ç¨ç«‹ä»»å‹™ï¼Œè€Œæˆ‘å€‘å¯ä»¥ **ä¸¦è¡Œ** åœ°é€²è¡Œé€™äº›ä»»å‹™ã€‚

èªªåˆ°ä¸¦è¡Œï¼Œé‚£ä»€éº¼æ˜¯ **å¹³è¡Œ** å‘¢ï¼Ÿ

å‡å¦‚ä½ åª½ä¹Ÿæƒ³å¹«ä½ ä¸€èµ·åšæ—©é¤ï¼Œè€Œä½ è² è²¬ã€Œçƒ¤åœŸå¸ã€æº–å‚™é†¬æ–™ã€ï¼Œè€Œä½ åª½è² è²¬ã€Œç…è›‹ã€æ“ºç›¤ã€ã€‚ä½ åšè‡ªå·±çš„ä»»å‹™ã€è€Œä½ åª½åšè‡ªå·±çš„ä»»å‹™â€”â€”é€™å°±æ˜¯ **å¹³è¡Œ**ã€‚

![ä¸¦è¡Œæ­é…å¹³è¡Œã€‚](parallelism.webp)

å›åˆ°é›»è…¦çš„ä¾‹å­ä¸Šã€‚æˆ‘å€‘å¯ä»¥æŠŠã€Œä½ ã€å’Œã€Œä½ åª½ã€æ¯”æ“¬ç‚º **CPU æ ¸å¿ƒ (core)** ï¼Œåˆ†é…çµ¦ä½ å’Œä½ åª½çš„ä¸€å¤§å †ç¨ç«‹ä»»å‹™å«åš **åŸ·è¡Œç·’ (thread)** ã€‚**ä¸¦è¡Œ** å°±æ˜¯å·¥ä½œå–®å…ƒè‡ªå·±ç”¨éåŒæ­¥çš„æ–¹å¼è™•ç†ä»»å‹™ï¼›**å¹³è¡Œ** å°±æ˜¯åˆ†é…å…¶ä»–å·¥ä½œå–®å…ƒè™•ç†ä»»å‹™ã€‚

### é€²éšé–±è®€ï¼šåŸ·è¡Œç·’æ±  (thread pool)

ä½ é›»è…¦çš„æ ¸å¿ƒæ˜¯æœ‰é™çš„ã€‚å°±ä»¥ Apple M1 é€™é¡† CPU ä¾†èªªï¼Œæœ€å¤šä¹Ÿå°±åªæœ‰ 8 å€‹æ ¸å¿ƒã€‚é‚£è¦æ€éº¼é«˜æ•ˆçš„æŠŠä¸€å¤§å †åŸ·è¡Œç·’ï¼Œéƒ½åˆ†é…åˆ°é€™äº› CPU ä¸Šå‘¢ï¼Ÿ

æˆ‘å€‘é€šå¸¸æŠŠé€™å€‹ã€Œåˆ†é…ã€å«åšèª¿åº¦ (schedulingï¼Œæ’ç¨‹ï¼‰ã€‚é¦–å…ˆï¼Œæœ€ç°¡å–®çš„åšæ³•å°±æ˜¯è‡ªå·±è·Ÿç³»çµ±é–‹åŸ·è¡Œç·’ï¼ˆé€šå¸¸æˆ‘å€‘æŠŠé€™ç¨®åŸ·è¡Œç·’å«åš **OS thread**ï¼‰ï¼š

![OS Thread](os-thread.webp)

åœ¨ Rust è£¡é¢ï¼Œä½¿ç”¨ OS thread æ˜¯éå¸¸ç°¡å–®çš„ï¼š

```rs
let handle = std::thread::spawn(|| {
  /* ä½ çš„åŒæ­¥ä½œæ¥­ */
});
```

é€™æ¨£çš„å¥½è™•æ˜¯ä¸éœ€è¦åœ¨ç¨‹å¼è£¡é¢åŒ…ä¸€å€‹èª¿åº¦å™¨ï¼Œä½†ç¼ºé»æ˜¯åŸ·è¡Œç·’çš„ **spawn** ç”Ÿæˆï¼ˆæŠŠä»»å‹™åˆ†é…çµ¦å®¶äººï¼‰å’Œ **destroy** éŠ·æ¯€ï¼ˆå‘Šè¨´å®¶äººä¸ç”¨ç¹¼çºŒåŸ·è¡Œä»»å‹™ï¼‰éƒ½å¾—æ‰¾ä½ çš„ä½œæ¥­ç³»çµ±ï¼ˆç®¡å®¶ï¼‰æ“ä½œã€‚é‚£å¦‚æœæˆ‘å€‘å¯ä»¥è‡ªå·±èª¿åº¦ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½æ¸›å°‘æ‰¾ä½œæ¥­ç³»çµ±ï¼ˆç®¡å®¶ï¼‰çš„é–‹éŠ·ï¼Œç”šè‡³æ˜¯åšåˆ°æ›´å¤šæ›´é«˜æ•ˆçš„äº‹æƒ…ï¼ˆæ¯”å¦‚åœ¨ä¸€å€‹åŸ·è¡Œç·’è£¡é¢åŸ·è¡Œæ•¸å€‹ä¸¦è¡Œä»»å‹™ï¼‰ï¼Ÿ

é¦–å…ˆï¼Œæˆ‘å€‘éœ€è¦å…ˆè·Ÿç®¡å®¶èªªã€Œæˆ‘éœ€è¦ N å€‹å¯ä»¥åˆ†é…å®¶äººä»»å‹™çš„åŸ·è¡Œç·’ï¼Œã€ç„¶å¾ŒæŠŠé€™äº›åŸ·è¡Œç·’éƒ½æ”¾é€²å»æˆ‘å€‘çš„ `thread pool`ã€‚æ¥ä¸‹ä¾†ç¨‹å¼éœ€è¦ thread åŸ·è¡Œä»»å‹™ï¼Œå°±è«‹ `thread pool` åˆ†é…ã€‚è€Œæˆ‘å€‘å¾ `thread pool` åˆ†é…åˆ°çš„åŸ·è¡Œç·’ï¼Œå°±æ˜¯ **green thread**ã€‚

ç”¨æ–‡å­—æè¿°å¤ªæ··äº‚ï¼Œç›´æ¥ç”¨åœ–è§£å§ï¼š

![Green threads](green-thread.webp)

ä½†å‡å¦‚æ¯å€‹ threads è£¡é¢éƒ½æ˜¯æœƒå µä½ç¨‹å¼çš„ä»»å‹™ (blocking)ï¼Œé‚£ Thread Pool è£¡é¢çš„ OS Thread å°±å¾—ç­‰é€™äº›ä»»å‹™å®Œæˆï¼Œæœ€å¾Œåè€Œæ²’æœ‰é”åˆ°é æœŸçš„é«˜æ•ˆåˆ†é…ã€‚å› æ­¤ï¼Œå¦‚æœ threads è£¡é¢æ˜¯å®Œå…¨ sync çš„ä»»å‹™ï¼Œå°± **æ²’æœ‰å¿…è¦ç”¨ä¸Š thread pool**ï¼Œè®“ OS åˆ†é…å³å¯ã€‚

![Thread pool in sync](thread-pool-sync.webp)

åä¹‹ï¼Œå¦‚æœ threads è£¡é¢çš„ä»»å‹™å¯ä»¥ä¸¦è¡Œï¼Œå› ç‚ºä¸€å€‹ thread å¯ä»¥ä¸¦è¡ŒåŸ·è¡Œå¤šå€‹ä»»å‹™ï¼Œthread pool çš„å®‰æ’å°±æœƒé¡¯å¾—æ¯” OS threads é«˜æ•ˆè¨±å¤šï¼š

![Thread pool in async](thread-pool-async.webp)

## é€²éšé–±è®€ï¼šFuture èˆ‡ Executor

> å°åº•å±¤æ¯”è¼ƒæ²’èˆˆè¶£ï¼Ÿå¯ä»¥å…ˆçœ‹ [Async å‡½æ•¸ã€å€å¡Šå’Œ await](#async-å‡½æ•¸å€å¡Šå’Œ-await)ã€‚

åŸºç¤ç†è«–çµæŸï¼Œæ‹‰å›ã€Œä»»å‹™ã€å’Œ Rust æœ¬èº«ã€‚ä½ æˆ–è¨±æœƒå¾ˆå¥½å¥‡ã€Œæ€éº¼è®“ Rust çŸ¥é“ä¸€å€‹ä»»å‹™æ˜¯å¦å®Œæˆï¼Ÿã€

é€™è£¡å°±è¦æåˆ° Rust çš„ Future äº†ã€‚Rust çš„ **Future** å°±æ˜¯ä¸€å€‹å¯ä¸¦è¡Œä»»å‹™çš„æŠ½è±¡è¡¨ç¤ºã€‚è€Œ **Executor** å°±æ˜¯è² è²¬è¼ªè©¢ (**polling**) Futures çš„ç¨‹å¼ã€‚æŠŠæˆ‘å€‘ä¹‹å‰çš„ã€ŒéåŒæ­¥ã€åœ–è§£ç”¨ Executor çš„è¦–è§’æç¹ªå‡ºä¾†ï¼š

![Executor å…§éƒ¨åŸºæœ¬ä¸Šæ€éº¼åˆ¤æ–·çš„](./how-executors-work.webp)

ç”¨æ–‡å­—è¡¨é”ï¼š

1. Executor æœƒå¾ Future Receiver æŠ“å‡ºä¸€å€‹ Futureã€‚
2. Executor åŸ·è¡Œé€™å€‹ä»»å‹™çš„ `poll()`ï¼Œä¸¦è§€å¯Ÿå…¶å›æ‡‰ã€‚
3. å¦‚æœæ˜¯ `Poll::Pending`ï¼ˆè™•ç†ä¸­ï¼‰ï¼Œå°±ç¹¼çºŒè™•ç†ä¸‹å€‹ä»»å‹™ã€‚
4. å¦‚æœæ˜¯ `Poll::Ready(T)`ï¼ˆå·²å®Œæˆï¼Œå›å‚³å€¼æ˜¯ Tï¼‰ï¼Œå‰‡å°‡å›å‚³å€¼äº¤çµ¦éœ€æ±‚æ–¹ã€‚

ä½†é€™å€‹æ–‡å­—æµç¨‹æœ‰å€‹å•é¡Œï¼š`poll()` åªæœƒåŸ·è¡Œä¸€æ¬¡å—ï¼Ÿå¦‚æœæœƒåŸ·è¡Œæ•¸æ¬¡ï¼Œé‚£ `poll()` ä¸‹æ¬¡æœƒåœ¨ä»€éº¼æ™‚å€™åŸ·è¡Œï¼Ÿé€™è£¡å°±å¾—æåˆ° Rust çš„ **waker** æ©Ÿåˆ¶äº†ã€‚æ¯ä¸€æ¬¡ `poll()`ï¼ŒExecutor éƒ½æœƒçµ¦é€™å€‹ä»»å‹™ä¸€å€‹ `context`ã€‚è£¡é¢æœ‰ä¸€å€‹ `waker`ï¼Œå¯ä»¥ç”¨ä¾†æé†’ Executorã€Œå¯ä»¥åŸ·è¡Œ `poll()` äº†ã€‚ã€

> å¦‚æœå°é€™æ–¹é¢æœ‰èˆˆè¶£çš„è©±ï¼Œå¯ä»¥åƒè€ƒ <https://weihanglo.tw/async-book/02_execution/03_wakeups.html>ã€‚å¦å¤– Future é‚„æœ‰å¾ˆå¤šå¾ˆå¤šçš„çŸ¥è­˜é»ï¼ˆ`Pin` ç­‰ç­‰ï¼‰ï¼Œç¤™æ–¼ç¯‡å¹…å°±å…ˆæ“±ç½®ã€‚

### å»¶ä¼¸é–±è®€ï¼šPolling ç­‰å„ç¨®æ–¹å¼çš„å„ªåŠ£

Pollingï¼ˆè¼ªè©¢ï¼‰ï¼Œç”¨ç¨‹å¼å¯«å‡ºä¾†æ˜¯åƒé€™æ¨£çš„ï¼š

```rs
loop {
  let status = task.poll();

  if let Polling::Ready(value) = status {
    return value;
  }

  continue;
}
```

é€™æ¨£æœ‰ä»€éº¼å•é¡Œï¼Ÿé¦–å…ˆéåŒæ­¥ä»»å‹™é€šå¸¸è¦ä¸€æ®µæ™‚é–“æ‰æœƒå®Œæˆï¼Œä¸€ç›´ `poll()` ä¸æœƒåŠ å¿«åŸ·è¡Œé€Ÿåº¦ã€‚å¦‚æœçœŸé€™æ¨£å¯«ï¼Œæœƒæµªè²»å¾ˆå¤š CPU æ™‚é–“åœ¨æ²’å¿…è¦çš„ `poll()` ä¸Šã€‚å¦å¤–ï¼Œ`loop {}` æ˜¯å€‹ *blocking* åŒæ­¥å‡½æ•¸ï¼Œé€™æ¨£å­å¯«ï¼Œä¸‹ä¸€å€‹ `Future` æ˜¯åŸ·è¡Œä¸äº†çš„ã€‚

é‚£æ›å¦ä¸€ç¨®æ–¹å¼å‘¢ï¼Ÿ

```rs
let (tx, rx) = std::sync::mpsc::channel();
let mut return_values = vec![];

for task in rx {
  let status = task.poll();

  if let Polling::Ready(value) = status {
    // å„²å­˜å›å‚³å€¼ï¼Œä¸å†æ’ç¨‹ã€‚
    return_values.push(value);
  } else {
    // ç¹¼çºŒæ’ç¨‹ã€‚
    tx.send(task);
  }
}
```

å…¶å¯¦é€™å°±ç›¸ç•¶æ–¼åœ¨ `poll()` éšæ®µå›å‚³ `Poll::Pending` å‰å‘¼å« `wake_by_ref()`â€”â€”é€™å€‹æ–¹æ³•è§£æ±ºäº† `loop {}` çš„å•é¡Œï¼Œä½†é‚„æ˜¯æ²’èƒ½è§£æ±ºã€Œæ²’å¿…è¦ `poll()` çš„å•é¡Œã€‚ã€

å€˜è‹¥å¦‚æœæˆ‘å€‘å¯ä»¥ç­‰åˆ°ä½œæ¥­å®Œæˆï¼Œå†åŸ·è¡Œ `wake()` å‘¢ï¼Ÿè¦é€™éº¼åšï¼Œæˆ‘å€‘å°±å¾—å…ˆçŸ¥é“ã€Œå·¥ä½œä»€éº¼æ™‚å€™æ‰å®Œæˆï¼Ÿã€å¦‚æœä»»å‹™æ˜¯ç”¨ callback æˆ– event å‘ŠçŸ¥ä»»å‹™ç‹€æ…‹çš„ï¼Œé‚£å°±æ˜¯åœ¨æ”¶åˆ° eventã€æˆ– callback è§¸ç™¼é€²è¡Œå‘¼å«ã€‚

> å»¶ä¼¸é–±è®€ï¼š<https://weihanglo.tw/async-book/02_execution/05_io.html>

## async å‡½æ•¸ã€å€å¡Šå’Œ await

ä¸Šé¢ä»‹ç´¹äº†å¾ˆå¤š Rust ä¸­ `Future` èˆ‡ `Executor` çš„ç†è«–åŸºç¤ï¼Œä½†å¯¦å‹™ä¸Šæ²’æœ‰é€™éº¼éº»ç…©ã€‚äº‹å¯¦ä¸Šåœ¨ Rust ä¸­ï¼Œç”¨ async å‡½æ•¸å’Œ block æ˜¯éå¸¸ç›´è¦ºçš„ã€‚

å°±ä»¥ä¸Šé¢çš„ [æ—©é¤ä¾‹å­](#åŒæ­¥-Synchronous-è·ŸéåŒæ­¥-Asynchoronous) ä¾†èªªï¼Œæˆ‘å€‘å¯ä»¥æŠŠå®ƒå…ˆæ”¹å¯«æˆé€™æ¨£ï¼š

```rs
async fn make_breakfast() -> Toast {
  let toast = bake_toast().await;
  let butter = prepare_peanut_butter().await;

  toast.apply(butter);
  toast
}
```

ä½ æˆ–è¨±æœƒå¾ˆç–‘æƒ‘ä»–è·Ÿä¸‹é¢é€™å€‹ç‰ˆæœ¬æœ‰ä»€éº¼å·®ç•°ï¼š

```rs
fn make_breakfast() -> Toast {
  let toast = bake_toast();
  let butter = prepare_peanut_butter();

  toast.apply(butter);
  toast
}
```

é¦–å…ˆï¼Œé›–ç„¶æ•´é«”ä¸Šã€Œåšæ—©é¤ã€é‚„æ˜¯å¾ªåºåŸ·è¡Œçš„ï¼ˆå…ˆçƒ¤å®Œåå¸ã€æ‰æº–å‚™èŠ±ç”Ÿé†¬ï¼‰ï¼Œä½†åšæ—©é¤é€™ä»¶äº‹æƒ…å› ç‚ºå·²ç¶“æ˜¯éåŒæ­¥çš„äº†ï¼Œæ‰€ä»¥ä½ å¯ä»¥åœ¨åšæ—©é¤çš„æ™‚å€™åšå…¶ä»–äº‹æƒ…ï¼š

![Sync in Async](./sync-in-async.webp)

å¾Œè€…çš„è©±å°±æ˜¯ç´” Syncï¼Œæ˜é¡¯æ˜¯æ¯”å‰è€…ä½æ•ˆçš„ï¼š

![ç´” Sync](./pure-sync.webp)

å°ç…§åœ–ç‰‡ï¼Œæˆ–è¨±ä½ ç™¼ç¾åˆ° `.await` å‰›å¥½å°±æ˜¯ã€Œä»»å‹™åˆ‡æ›é»ã€ã€‚`.await` ä¹‹å¾Œï¼Œä½ å¯ä»¥å»åšå…¶ä»–äº‹æƒ…ï¼ˆè€Œä¸æ˜¯ç©ºç­‰ï¼‰ã€‚ç­‰åˆ°çƒ¤ç®±è²éŸ³éŸ¿äº†ä¹‹å¾Œ ([`wake()`](#é€²éšé–±è®€future-èˆ‡-executor)) ä¹‹å¾Œå†å›ä¾†åšå‰©ä¸‹çš„äº‹æƒ…ã€‚æ‰€ä»¥æ•´é«”ä¸Š async å‡½æ•¸æ˜¯æ¯”è¼ƒé«˜æ•ˆçš„ï¼Œä½†æˆ‘å€‘è¦æ€éº¼è®“æ•´å€‹ä»»å‹™æ›´é«˜æ•ˆå‘¢ï¼ˆåœ¨ async è£¡é¢ä¸€æ¬¡æ€§åŸ·è¡Œæ›´å¤šä»»å‹™ï¼Ÿï¼‰

### åœ¨ async å‡½æ•¸è£¡é¢ä¸¦è¡ŒåŸ·è¡Œæ•¸å€‹ä»»å‹™ (futures)

å‰›æ‰æåˆ°æˆ‘å€‘å¸Œæœ›åœ¨ä¸€å€‹ async è£¡é¢ä¸€æ¬¡æ€§åŸ·è¡Œæ•¸å€‹ä»»å‹™ã€‚é€™è£¡æˆ‘å€‘å¯ä»¥å€ŸåŠ© `tokio` çš„ [`join!()`](https://docs.rs/tokio/latest/tokio/macro.join.html) å·¥å…·å·¨é›†ï¼Œè¡¨ç¤ºã€Œæˆ‘å¸Œæœ›é€™å…©å€‹ä»»å‹™åŒæ™‚æ“ä½œã€ï¼Œå°±åƒæ˜¯æŠŠé€™å…©å€‹ä»»å‹™èåˆç‚ºä¸€äº†ï¼š

```rs
async fn make_breakfast() -> Toast {
  let (toast, butter) = tokio::join!(
    // è¦æ³¨æ„é€™è£¡ä¸éœ€è¦ .awaitï¼Œ
    // await çš„äº‹æƒ… `join!()` æœƒè™•ç†ã€‚
    bake_toast(),
    prepare_peanut_butter()
  );

  toast.apply(butter);
  toast
}
```

é€™æ¨£ `make_breakfast` è£¡é¢å°±æ˜¯é«˜æ•ˆçš„æ¨¡å¼äº†ï¼š

![Async in async](./async-in-async.webp)

é‚£æ›ä¸€ç¨®ç¾å¯¦ä¸­ä¹Ÿå¸¸é‡åˆ°çš„ä¾‹å­ï¼šä½ å¸Œæœ›æ—©é¤å¯ä»¥åœ¨å°å­©ä¸Šå­¸å‰åšå®Œï¼Œå¦‚æœæ²’åšå®Œå°±ä¸è¦ç¹¼çºŒåšäº†ã€‚æ‰€ä»¥æˆ‘å€‘æƒ³è¦è¨­ç½®ä¸€å€‹è¨ˆæ™‚å™¨ï¼Œå¦‚æœè¨ˆæ™‚åˆ°äº†é‚„æ²’åšå®Œå°±ç›´æ¥å–æ¶ˆï¼›åä¹‹å°±ç¹¼çºŒåšï¼š

![Async with timeout](./async-with-timeout.webp)

é€™ç¨®æƒ…æ³å°±å¯ä»¥ç”¨ [`tokio::select!()`](https://docs.rs/tokio/latest/tokio/macro.select.html)â€”â€”åŒæ™‚ç­‰ã€Œåšæ—©é¤ã€è·Ÿã€Œè¨ˆæ™‚å™¨ã€ï¼Œå›å‚³å®Œæˆé€Ÿåº¦æœ€å¿«çš„ä»»å‹™ï¼ˆåˆ†æ”¯ï¼‰ï¼Œè€Œå–æ¶ˆå‰©ä¸‹æ²’åšå®Œçš„ä»»å‹™ï¼ˆåˆ†æ”¯ï¼‰ï¼š

```rs
// Option åŒ…å«ã€Œæœ‰ã€æˆ–ã€Œæ²’æœ‰ã€å…©ç¨®å¯èƒ½ã€‚å¦‚æœè¨ˆæ™‚å™¨åˆ°äº†ï¼Œ
// åå¸é‚„æ²’å®Œæˆï¼Œé‚£å°±æ²’æœ‰æ—©é¤ï¼›åä¹‹ï¼Œå°±æœ‰æ—©é¤ã€‚
async fn make_breakfast_with_timer() -> Option<Toast> {
  tokio::select! {
    // å¦‚æœæ—©é¤å…ˆå®Œæˆï¼Œé‚£å°±æœ‰æ—©é¤ã€‚
    toast = make_breakfast() => Some(toast),

    // å¦‚æœæ™‚é–“å…ˆåˆ°ï¼Œé‚£å°±æ²’æ—©é¤ã€‚
    _ = timer() => None,
  }
}

/// ä¸€å€‹è¨­å®šåœ¨ 30 åˆ†é˜çš„è¨ˆæ™‚å™¨
async fn timer() {
  tokio::time::sleep(
    std::time::Duration::from_secs(30 /* min */ * 60 /* sec */)
  ).await
}

async fn make_breakfast() -> Toast {
  let (toast, butter) = tokio::join!(
    bake_toast(),
    prepare_peanut_butter()
  );

  toast.apply(butter);
  toast
}
```

å¦‚æœä½ å°é€™æ–¹é¢å¾ˆæœ‰èˆˆè¶£ï¼Œå¯ä»¥çœ‹çœ‹ <https://weihanglo.tw/async-book/06_multiple_futures/01_chapter.html>ã€‚

### å»¶ä¼¸é–±è®€ï¼šawait åªèƒ½åœ¨ async function è£¡é¢åŸ·è¡Œ

è¦æ³¨æ„çš„ï¼Œæ˜¯ `.await` åªèƒ½åœ¨ async block æˆ– async function è£¡é¢ä½¿ç”¨ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œä½ ä¸èƒ½åœ¨åŒæ­¥å‡½æ•¸ï¼ˆåŒ…æ‹¬ `main()`ï¼‰è£¡é¢å‘¼å«éåŒæ­¥å‡½æ•¸ï¼š

```rs
fn main() {
  // æœƒç·¨è­¯éŒ¯èª¤ï¼
  let file_content = make_breakfast().await;

  // é‚„æ˜¯ä¸è¡Œ ğŸ˜„
  let file_content = async {
    make_breakfast().await
  }.await; /* async block ä¹Ÿéœ€è¦ await */
}
```

æ—¢ç„¶æ¯å€‹å‘¼å«è€…éƒ½å¿…é ˆæ˜¯ async çš„ï¼Œ**é‚£æ˜¯èª°å‘¼å«ç¬¬ä¸€å€‹ async å‡½æ•¸å‘¢ï¼Ÿ** [é€™å°±å¾—æåˆ° Async Runtime äº†ã€‚](#rust-çš„-async-runtime)

### é€²éšé–±è®€ï¼šå¾ Future çœ‹ async å’Œ await

ä½†é€™è£¡é¢çš„ async å’Œ await åˆ†åˆ¥ä»£è¡¨ä»€éº¼æ„ç¾©å‘¢ï¼Ÿ`async fn` å…¶å¯¦å±•é–‹ä¾†çœ‹ï¼Œå°±æ˜¯ä¸€å€‹å›å‚³ Future çš„å‡½æ•¸ï¼š

```rs
struct ReadFileFuture { ... }

impl Future for ReadFileFuture {
  type Output = String;

  fn poll(...) { ... }
}

fn read_file(path: &Path) -> ReadFileFuture {}
```

è€Œ await çš„å¤§è‡´æ„æ€å°±æ˜¯ã€Œæ²’å®Œæˆå°±èªªæ•´å€‹å‡½æ•¸æ²’å®Œæˆï¼›å®Œæˆå°±ç¹¼çºŒã€ï¼š

```rs
// æŠŠé€™å€‹å‡½æ•¸çš„ context è½‰äº¤çµ¦ read_to_string
let content_status = tokio::fs::read_to_string(path).poll(cx);

let content = match content_status {
  // å¦‚æœé€™å€‹ feature æ²’å®Œæˆï¼Œå°±å‰©ä¸‹çš„ async ä¹Ÿå°±ç„¡æ³•ç¹¼çºŒã€‚
  Poll::Pending => return Poll::Pending,

  // åä¹‹ï¼ŒæŠŠå€¼æ‹¿å›ä¾†
  Poll::Ready(c) => c,
}
```

å¯¦éš›ä¸Šé€™éƒ¨åˆ†é‚„æœ‰è¨±å¤šåœ°æ–¹éœ€è¦è€ƒæ…®ï¼šåŒ…æ‹¬è¦æ€éº¼åœ¨ä¸‹æ¬¡å‘¼å« `poll()` çš„æ™‚å€™ï¼ŒçŸ¥é“ç¾åœ¨è¦ç¹¼çºŒåŸ·è¡Œå“ªå€‹ `Future`ã€‚æ›´è©³ç´°çš„è³‡è¨Šå¯ä»¥åƒè€ƒ <https://weihanglo.tw/async-book/02_execution/02_future.html>ã€‚

## Rust çš„ async runtime

å¯¦å‹™ä¸Šä½ ä¸éœ€è¦è‡ªå·±å¯«ä¸€å€‹ executorï¼Œ**è€Œæ˜¯ä½¿ç”¨ç¾æˆçš„ async runtimeï¼ˆåŸ·è¡Œéšæ®µã€åŸ·è¡Œæ™‚ï¼‰**ã€‚ä¸€å€‹ **async runtime** é™¤äº† executor ä¹‹å¤–ï¼Œé‚„æœ‰æä¾›å¾ˆå¤šåŠŸèƒ½ï¼ˆæ¯”å¦‚ä¸Šæ–‡æåŠçš„ thread poolã€å·¥å…·å·¨é›†å’Œå‡½æ•¸ï¼Œä»¥åŠæª”æ¡ˆè®€å¯«ã€channel ç­‰ç­‰å¸¸ç”¨åŠŸèƒ½çš„éåŒæ­¥å°æ‡‰æ–¹æ³•ï¼‰ã€‚

å¸¸è¦‹çš„ async runtime æœ‰ `tokio`ã€`async-std` å’Œ `smol`ï¼Œå…¶ä¸­åˆä»¥ `tokio` å’Œ `async-std` ç‚ºå¤§å®—ã€‚ä¸‹æ–‡æœƒä»¥ `tokio` ä½œç‚ºä»‹ç´¹ç¯„ä¾‹ã€‚

### è®“ `main()` è®Šæˆ async å‡½æ•¸çš„èµ·æºåœ°

æˆ‘å€‘åœ¨[ã€ˆå»¶ä¼¸é–±è®€ï¼šawait åªèƒ½åœ¨ async function è£¡é¢åŸ·è¡Œã€‰](#å»¶ä¼¸é–±è®€await-åªèƒ½åœ¨-async-function-è£¡é¢åŸ·è¡Œ)è£¡é¢æœ‰æåŠã€Œæ‰€æœ‰å‘¼å«è€…å¿…é ˆéƒ½æ˜¯ *async function*ï¼Œã€é‚£ `main()` å‘¢ï¼Ÿ

é‚„è¨˜å¾—ä¸Šæ–‡æœ‰æåˆ°ã€ŒFutures éœ€è¦ä¸€å€‹ *executor* èª¿åº¦ï¼Ÿã€é‚£ `main()` åŸå‰‡ä¸Šå°±æ˜¯é…ç½® runtimeï¼Œè®“ runtime æº–å‚™ executor çš„åœ°æ–¹ï¼š

```rs
fn main() {
  // è¨­å®šå¤šåŸ·è¡Œç·’çš„ tokio runtimeã€‚
  tokio::runtime::Builder::new_multi_thread()
    // å•Ÿç”¨æ‰€æœ‰åŠŸèƒ½ã€‚
    .enable_all()
    // å»ºæ§‹ runtimeã€‚
    .build()
    // å¦‚æœ runtime å»ºæ§‹å¤±æ•—å°±åœä½æ•´å€‹ç¨‹å¼ã€‚
    .unwrap()
    // async å‡½æ•¸çš„èµ·æºåœ°â€”â€”å µå¡ (blocking)ï¼Œ
    // è®“æ•´å€‹ main() ç­‰å¾…é€™å€‹ async å‡½æ•¸å®Œæˆã€‚
    .block_on(async {
        println!("Hello world");
    })

  // ç„¶å¾Œç¨‹å¼å°±å¯ä»¥çµæŸäº†ã€‚
}
```

ä¸éå…¶å¯¦ä¸ç”¨é€™éº¼éº»ç…©ï¼š[`tokio::main!`](https://docs.rs/tokio/latest/tokio/attr.main.html) é€™å€‹ **å±¬æ€§å·¨é›† (attribute macro)** å°±èƒ½å¹«ä½ å¯«å¥½é€™æ–¹é¢çš„åˆå§‹åŒ–äº†ã€‚ä½ åªè¦é€™æ¨£å°±å¥½ï¼š

```rs
#[tokio::main]
async fn main() {
  println!("Hello, World!");
}
```

### é€²éšé–±è®€ï¼šè®“ä¸€å€‹ä»»å‹™ (Future) è®Šæˆä¸€å€‹ç¶ è‰²åŸ·è¡Œç·’ (Green Thread)â€”â€”`spawn`

é‚„è¨˜å¾—ä¸¦è¡Œ (Concurrent) è·Ÿå¹³è¡Œ (Parallelism) å—ï¼Ÿé›–ç„¶å¤§éƒ¨åˆ†çš„æƒ…æ³ä¸‹ï¼Œåœ¨ **å–®åŸ·è¡Œç·’**ã€Œä¸¦è¡Œã€å°±å·²ç¶“å¾ˆè¶³å¤ å¿«äº†ã€‚å€˜è‹¥é€™å€‹ä»»å‹™è€—æ™‚å¾ˆé•·ï¼Œä½ å¸Œæœ›é–‹å¦ä¸€æ¢åŸ·è¡Œç·’ã€Œå¹³è¡Œã€å°ˆé–€è™•ç†é€™å€‹ä»»å‹™ï¼Œé‚£å°±å¯ä»¥ç”¨ `spawn`ï¼š

```rs
let handle = tokio::task::spawn(async {
  /* ç¾åœ¨é€™è£¡é¢çš„æ±è¥¿ï¼Œéƒ½åœ¨ç¨ç«‹çš„ thread è£¡é¢è·‘äº†ï¼ */ 
});
```

[`tokio::task::spawn`](https://docs.rs/tokio/latest/tokio/task/fn.spawn.html) é›–ç„¶ç”¨èµ·ä¾†å¾ˆåƒå»ºç«‹ OS thread çš„ `std::thread::spawn`ï¼Œä½† **spawn è£¡é¢ä¸è¦æ”¾é«˜è€—æ™‚çš„åŒæ­¥å‡½æ•¸**â€”â€”é™¤éä½ æ¨‚è¦‹æ•´å€‹ runtime è¢«å¡åœ¨ä¸€ä»¶ä»»å‹™ä¸Šé¢ï¼ˆæˆ–è€…æ˜¯ç›´æ¥æŠŠ runtime ææ­»ï¼Œç›´æ¥ panicï¼ï¼‰

é‚£è¦æ€éº¼åœ¨éåŒæ­¥å‡½æ•¸è£¡é¢ï¼Œé–‹å¦ä¸€å€‹ thread è·‘åŒæ­¥å‡½æ•¸å‘¢ï¼Ÿä½ å¯ä»¥ç”¨æ¥ä¸‹ä¾†æœƒæåˆ°çš„ `tokio::task::spawn_blocking`ã€‚

### åœ¨éåŒæ­¥å‡½æ•¸è£¡é¢å‘¼å«é«˜è€—æ™‚åŒæ­¥å‡½æ•¸â€”â€”`spawn_blocking`

é™¤äº†é–‹ä¸€å€‹ `std::thread::spawn` OS thread è·‘é€™ç¨®å‡½æ•¸ä¹‹å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨
[`tokio::task::spawn_blocking`](https://docs.rs/tokio/latest/tokio/task/fn.spawn_blocking.html) é–‹ä¸€å€‹ **å¯ä»¥ await** çš„åŒæ­¥ *blocking* å µå¡å‡½æ•¸ã€‚

```rs
let _this_returns_42 = tokio::task::spawn_blocking(|| {
  for i in 0..114514 {
    for j in 0..1919810 {}
  }

  42
}).await;
```

é€™æ¨£å­è·‘é«˜è€—æ™‚çš„å‡½æ•¸ä¹‹æ™‚ï¼Œç…§æ¨£å¯ä»¥åŸ·è¡Œå…¶ä»–ä¸ç”¨å µå¡çš„ä»»å‹™ã€‚åŒç†ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠé€™å€‹å¥—é€²å» `join!` ä¸¦è¡Œå®Œæˆï¼Œå¯æ˜¯ **é€™æ¨£å»ºç«‹å‡ºçš„ thread æ˜¯å–æ¶ˆä¸äº†çš„â€”â€”ä¸åªæ˜¯å–®ç´”çš„ `select!`ï¼Œé‚„åŒ…å« `.abort()`** ã€‚å› æ­¤é‚„æ˜¯ç›¡é‡é¸æ“‡ä¸¦å–„ç”¨éåŒæ­¥å‡½æ•¸ã€‚æƒ³æ·±å…¥äº†è§£ sync å‡½æ•¸èˆ‡ async å‡½æ•¸æ©‹æ¥çš„è³‡è¨Šï¼Œå¯ä»¥åƒè€ƒ <https://tokio.rs/tokio/topics/bridging>ã€‚

## çµèª

åŸºæœ¬ä¸ŠæŠŠé€™å‰‡ Twitter æ¨æ–‡æƒ³è¦çŸ¥é“çš„å¤§éƒ¨åˆ†çŸ¥è­˜é»éƒ½è¬›äº†ã€‚ç¤™æ–¼å€‹äººèƒ½åŠ›ä¸è¶³ï¼Œæˆ–è¨±è¬›å¾—ä¸å¤ æ¸…æ™°æˆ–ä¸ç”šæ˜ç¢ºï¼Œä¹Ÿååˆ†æ­¡è¿å„è·¯å°ˆå®¶æŒ‡æ­£ QQ

å¦å¤–é€™ç¯‡æ–‡ç« èŠ±äº†æˆ‘ 7hr ä¾†å¯«ï¼Œå¦‚æœè¦ºå¾—æœ‰ç”¨çš„è©±ï¼Œæ­¡è¿æŠŠé€™ç¯‡æ–‡ç« åˆ†äº«çµ¦æ›´å¤šå° async ä»¥åŠ Rust éåŒæ­¥ç¨‹å¼æœ‰èˆˆè¶£çš„äºº owo è¬è¬ ğŸ™

![7hr!!!](./how-long-i-wasted.webp)  

å¦å¤–ä¹Ÿå¯ä»¥ follow æˆ‘çš„ [GitHub](http://github.com/pan93412) æ”¯æŒæˆ‘çš„ OSS å·¥ä½œ ouo

## åƒè€ƒæ–‡ç»

- <https://medium.com/erens-tech-book/%E7%90%86%E8%A7%A3-process-thread-94a40721b492>
- <https://hackmd.io/@sysprog/concurrency/https%3A%2F%2Fhackmd.io%2F%40sysprog%2FS1AMIFt0D#Concurrency-%E4%B8%A6%E8%A1%8C-vs-Parallelism-%E5%B9%B3%E8%A1%8C>
- <https://weihanglo.tw/async-book/02_execution/02_future.html>
- <https://en.wikipedia.org/wiki/Scheduling_(computing)>
- <https://zh.wikipedia.org/wiki/ç»¿è‰²çº¿ç¨‹>
- <https://doc.rust-lang.org/std/future/trait.Future.html>
- and more, a lot. Thanks to these authors â¤ï¸
